<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#ff4500">
<link rel="manifest" href="manifest.json">
<title>MRF Token Scanner</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap');
:root{
  --bg:#0f0f0f;--surface:#1c1c1e;--border:#2c2c2e;
  --accent:#ff4500;--gold:#ffd60a;--text:#f5f5f7;
  --muted:#8e8e93;--green:#30d158;--red:#ff453a;--blue:#0a84ff;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;overflow:hidden;}
.screen{display:none;flex-direction:column;height:100vh;overflow:hidden;}
.screen.active{display:flex;}

/* TOPBAR */
.topbar{flex-shrink:0;display:flex;align-items:center;justify-content:space-between;padding:50px 20px 14px;background:var(--surface);border-bottom:1px solid var(--border);}
.topbar-title{font-size:1.1rem;font-weight:800;}
.topbar-title span{color:var(--accent);}
.topbar-sub{font-size:0.68rem;color:var(--muted);font-family:'Space Mono',monospace;}
.back-btn{background:var(--border);border:none;color:var(--text);border-radius:8px;padding:8px 14px;font-family:'Syne',sans-serif;font-weight:700;font-size:0.85rem;cursor:pointer;}

/* HOME */
.scroll-content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:20px;}
.section-label{font-size:0.65rem;font-family:'Space Mono',monospace;color:var(--muted);text-transform:uppercase;letter-spacing:2px;margin-bottom:8px;}
.dealer-input{width:100%;background:var(--surface);border:1.5px solid var(--border);border-radius:12px;color:var(--text);font-family:'Syne',sans-serif;font-size:1rem;padding:14px 16px;outline:none;margin-bottom:14px;}
.dealer-input:focus{border-color:var(--accent);}
.scan-btn{width:100%;background:var(--accent);border:none;border-radius:16px;color:white;font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:800;padding:20px;cursor:pointer;margin-bottom:16px;box-shadow:0 4px 24px rgba(255,69,0,0.4);}
.scan-btn:active{opacity:0.85;}
.stats-strip{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;}
.stat-box{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px;}
.stat-label{font-size:0.62rem;color:var(--muted);font-family:'Space Mono',monospace;margin-bottom:4px;}
.stat-value{font-size:1.5rem;font-weight:800;}
.stat-value.money{color:var(--gold);}
.entry-card{background:var(--surface);border:1px solid var(--border);border-left:3px solid var(--gold);border-radius:12px;padding:14px 16px;margin-bottom:10px;}
.entry-card.approved{border-left-color:var(--green);}
.entry-top{display:flex;justify-content:space-between;margin-bottom:3px;}
.entry-dealer{font-weight:700;}
.entry-amount{font-weight:800;color:var(--gold);font-family:'Space Mono',monospace;}
.entry-detail{font-size:0.7rem;color:var(--muted);font-family:'Space Mono',monospace;margin-top:2px;}
.entry-actions{display:flex;gap:8px;margin-top:10px;}
.btn-approve{flex:1;background:var(--green);color:#000;border:none;border-radius:8px;padding:8px;font-family:'Syne',sans-serif;font-weight:700;font-size:0.8rem;cursor:pointer;}
.btn-del{background:var(--border);color:var(--muted);border:none;border-radius:8px;padding:8px 14px;cursor:pointer;}
.empty-note{text-align:center;color:var(--muted);font-size:0.82rem;padding:32px 0;font-family:'Space Mono',monospace;line-height:1.8;}
.bottom-nav{flex-shrink:0;display:flex;background:var(--surface);border-top:1px solid var(--border);padding:10px 0 28px;}
.nav-btn{flex:1;background:none;border:none;color:var(--muted);font-family:'Syne',sans-serif;font-size:0.7rem;font-weight:700;display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;padding:6px 0;}
.nav-btn.active{color:var(--accent);}
.nav-icon{font-size:20px;}

/* SCANNER SCREEN */
#scanScreen{background:#000;}
.camera-wrap{position:relative;width:100%;background:#000;overflow:hidden;flex-shrink:0;}
#videoEl{width:100%;display:block;object-fit:cover;}
#snapCanvas{display:none;}

/* Detection overlay on camera */
.detect-frame{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:200px;height:200px;pointer-events:none;}
.detect-frame .corner{position:absolute;width:32px;height:32px;}
.detect-frame .corner.tl{top:0;left:0;border-top:3px solid var(--accent);border-left:3px solid var(--accent);}
.detect-frame .corner.tr{top:0;right:0;border-top:3px solid var(--accent);border-right:3px solid var(--accent);}
.detect-frame .corner.bl{bottom:0;left:0;border-bottom:3px solid var(--accent);border-left:3px solid var(--accent);}
.detect-frame .corner.br{bottom:0;right:0;border-bottom:3px solid var(--accent);border-right:3px solid var(--accent);}
.detect-frame.detected .corner{border-color:var(--green);}
.detect-frame.detected{animation:pulse 0.3s ease;}
@keyframes pulse{0%{transform:translate(-50%,-50%) scale(1);}50%{transform:translate(-50%,-50%) scale(1.1);}100%{transform:translate(-50%,-50%) scale(1);}}

/* Detection result popup */
.detect-popup{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  background:rgba(0,0,0,0.92);border-radius:20px;
  padding:20px 28px;text-align:center;min-width:220px;
  border:2px solid var(--green);display:none;
  animation:popIn 0.2s ease;
}
@keyframes popIn{from{transform:translate(-50%,-50%) scale(0.8);opacity:0;}to{transform:translate(-50%,-50%) scale(1);opacity:1;}}
.detect-popup.show{display:block;}
.popup-denom{font-size:2.5rem;font-weight:800;color:var(--gold);}
.popup-label{font-size:0.8rem;color:var(--muted);font-family:'Space Mono',monospace;margin-bottom:12px;}
.popup-color{font-size:0.75rem;color:var(--muted);font-family:'Space Mono',monospace;margin-bottom:16px;}
.popup-btns{display:flex;gap:10px;}
.btn-confirm{flex:1;background:var(--green);color:#000;border:none;border-radius:10px;padding:12px;font-family:'Syne',sans-serif;font-weight:800;font-size:1rem;cursor:pointer;}
.btn-reject{flex:1;background:var(--red);color:white;border:none;border-radius:10px;padding:12px;font-family:'Syne',sans-serif;font-weight:800;font-size:1rem;cursor:pointer;}

/* Scanning status bar */
.scan-status{flex-shrink:0;padding:10px 16px;background:var(--surface);display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);}
.status-text{font-size:0.8rem;font-family:'Space Mono',monospace;color:var(--muted);}
.status-text.active{color:var(--gold);}
.status-count{font-size:0.9rem;font-weight:800;color:var(--text);}

/* Tally strip - scrollable horizontal */
.tally-strip{flex-shrink:0;display:grid;grid-template-columns:repeat(6,1fr);gap:5px;padding:8px 10px;background:var(--bg);border-bottom:1px solid var(--border);}
.tally-tile{border-radius:8px;padding:6px 4px;text-align:center;border:1.5px solid var(--border);}
.tally-tile.lit{border-color:var(--gold);}
.tally-denom{font-size:0.55rem;color:var(--muted);font-family:'Space Mono',monospace;}
.tally-count{font-size:1.2rem;font-weight:800;}
.tally-val{font-size:0.55rem;color:var(--gold);font-family:'Space Mono',monospace;}
.t25b{background:#2a1206;}.t50b{background:#1e0a2e;}.t75b{background:#0a2e14;}
.t100b{background:#2e0a0a;}.t150b{background:#0a1a2e;}.t200b{background:#2e0a20;}

/* Recent scans list */
.scan-log{flex:1;overflow-y:auto;padding:8px 12px;}
.scan-item{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--surface);border-radius:10px;margin-bottom:6px;animation:slideIn 0.2s ease;}
@keyframes slideIn{from{transform:translateX(20px);opacity:0;}to{transform:translateX(0);opacity:1;}}
.scan-dot{width:14px;height:14px;border-radius:3px;flex-shrink:0;}
.scan-info{flex:1;}
.scan-denom{font-weight:800;font-size:0.9rem;}
.scan-time{font-size:0.65rem;color:var(--muted);font-family:'Space Mono',monospace;}
.scan-amount{font-weight:800;color:var(--gold);font-family:'Space Mono',monospace;}
.scan-undo{background:none;border:1px solid var(--border);color:var(--muted);border-radius:6px;padding:4px 10px;font-size:0.7rem;cursor:pointer;font-family:'Space Mono',monospace;}
.scan-undo:active{background:var(--red);color:white;border-color:var(--red);}

/* Bottom action bar */
.scan-actions{flex-shrink:0;padding:10px 12px 28px;background:var(--surface);border-top:1px solid var(--border);display:flex;flex-direction:column;gap:8px;}
.big-btn{width:100%;border:none;border-radius:14px;font-family:'Syne',sans-serif;font-weight:800;font-size:0.95rem;padding:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;}
.big-btn:active{opacity:0.8;}
.big-btn.primary{background:var(--accent);color:white;}
.big-btn.scanning{background:#1a5c1a;color:white;}
.big-btn.gold{background:var(--gold);color:#000;}
.big-btn.blue{background:var(--blue);color:white;}
.big-btn.secondary{background:var(--border);color:var(--text);}
.big-btn:disabled{opacity:0.3;pointer-events:none;}

/* Total bar */
.total-bar{flex-shrink:0;display:flex;justify-content:space-between;align-items:center;padding:10px 16px;background:#1a0a00;border-bottom:1px solid #3d1f00;}
.total-label{font-size:0.7rem;color:var(--muted);font-family:'Space Mono',monospace;}
.total-tokens{font-size:0.8rem;color:var(--muted);font-family:'Space Mono',monospace;}
.total-amount{font-size:1.4rem;font-weight:800;color:var(--gold);font-family:'Space Mono',monospace;}

/* LOG SCREEN */
.grand-bar{background:var(--accent);border-radius:12px;padding:16px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;}
.gt-label{font-size:0.75rem;font-weight:700;opacity:0.85;}
.gt-sub{font-size:0.62rem;opacity:0.65;font-family:'Space Mono',monospace;}
.gt-amt{font-size:1.6rem;font-weight:800;font-family:'Space Mono',monospace;}
.report-btns{display:flex;gap:10px;margin-top:16px;}
.btn-excel{flex:1;background:#1d6f42;color:white;border:none;border-radius:12px;padding:14px;font-family:'Syne',sans-serif;font-weight:700;font-size:0.9rem;cursor:pointer;}
.btn-whatsapp{flex:1;background:#25d366;color:white;border:none;border-radius:12px;padding:14px;font-family:'Syne',sans-serif;font-weight:700;font-size:0.9rem;cursor:pointer;}

@keyframes spin{to{transform:rotate(360deg);}}
.spinner{display:inline-block;width:13px;height:13px;border:2px solid transparent;border-top-color:currentColor;border-radius:50%;animation:spin 0.6s linear infinite;vertical-align:middle;margin-right:6px;}

/* INSTALL BANNER */
.install-banner{position:fixed;bottom:80px;left:16px;right:16px;z-index:999;background:var(--surface);border:1.5px solid var(--accent);border-radius:16px;padding:14px 16px;display:flex;align-items:center;gap:12px;box-shadow:0 8px 32px rgba(0,0,0,0.5);}
.install-banner.hidden{display:none;}
.btn-install{background:var(--accent);color:white;border:none;border-radius:8px;padding:8px 14px;font-family:'Syne',sans-serif;font-weight:700;font-size:0.8rem;cursor:pointer;}
.btn-dismiss{background:none;border:none;color:var(--muted);font-size:0.75rem;cursor:pointer;}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê -->
<div class="screen active" id="homeScreen">
  <div class="topbar">
    <div><div class="topbar-title">MRF <span>Tokens</span></div><div class="topbar-sub">Vapocure Dealer Incentive</div></div>
  </div>
  <div class="scroll-content">
    <div class="section-label">Dealer Name / Code</div>
    <input class="dealer-input" id="dealerName" type="text" placeholder="e.g. Ravi Paints ‚Äî DLR-042"/>
    <button class="scan-btn" onclick="goToScan()">üì∑ Start Scanning Tokens</button>
    <div class="stats-strip">
      <div class="stat-box"><div class="stat-label">TODAY'S ENTRIES</div><div class="stat-value" id="statEntries">0</div></div>
      <div class="stat-box"><div class="stat-label">TOTAL PAYOUT</div><div class="stat-value money" id="statTotal">‚Çπ0</div></div>
    </div>
    <div class="section-label">Recent Entries</div>
    <div id="recentList"><div class="empty-note">No entries yet.<br>Tap "Start Scanning Tokens" to begin.</div></div>
  </div>
  <div class="bottom-nav">
    <button class="nav-btn active" onclick="showScreen('homeScreen')"><span class="nav-icon">üè†</span>Home</button>
    <button class="nav-btn" onclick="goToScan()"><span class="nav-icon">üì∑</span>Scan</button>
    <button class="nav-btn" onclick="showScreen('logScreen')"><span class="nav-icon">üìã</span>Log</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê SCAN ‚ïê‚ïê‚ïê -->
<div class="screen" id="scanScreen">
  <div class="topbar">
    <button class="back-btn" onclick="stopAndBack()">‚Üê Back</button>
    <div style="text-align:right">
      <div class="topbar-title">Scan <span>Tokens</span></div>
      <div class="topbar-sub" id="scanDealerLabel">‚Äî</div>
    </div>
  </div>

  <!-- Live camera -->
  <div class="camera-wrap" id="cameraWrap">
    <video id="videoEl" autoplay playsinline muted></video>
    <canvas id="snapCanvas"></canvas>
    <!-- Targeting frame -->
    <div class="detect-frame" id="detectFrame">
      <div class="corner tl"></div><div class="corner tr"></div>
      <div class="corner bl"></div><div class="corner br"></div>
    </div>
    <!-- Detection result popup -->
    <div class="detect-popup" id="detectPopup">
      <div class="popup-denom" id="popupDenom">‚Çπ100</div>
      <div class="popup-label">Token detected!</div>
      <div class="popup-color" id="popupColor">Bright red background</div>
      <div class="popup-btns">
        <button class="btn-confirm" onclick="confirmToken()">‚úì Yes</button>
        <button class="btn-reject" onclick="rejectToken()">‚úó No</button>
      </div>
    </div>
  </div>

  <!-- Status -->
  <div class="scan-status">
    <div class="status-text" id="statusText">Point camera at a token</div>
    <div class="status-count" id="statusCount">0 scanned</div>
  </div>

  <!-- 6 denomination tally -->
  <div class="tally-strip">
    <div class="tally-tile t25b" id="tile25"><div class="tally-denom">‚Çπ25</div><div class="tally-count" id="tc25">0</div><div class="tally-val" id="tv25">‚Çπ0</div></div>
    <div class="tally-tile t50b" id="tile50"><div class="tally-denom">‚Çπ50</div><div class="tally-count" id="tc50">0</div><div class="tally-val" id="tv50">‚Çπ0</div></div>
    <div class="tally-tile t75b" id="tile75"><div class="tally-denom">‚Çπ75</div><div class="tally-count" id="tc75">0</div><div class="tally-val" id="tv75">‚Çπ0</div></div>
    <div class="tally-tile t100b" id="tile100"><div class="tally-denom">‚Çπ100</div><div class="tally-count" id="tc100">0</div><div class="tally-val" id="tv100">‚Çπ0</div></div>
    <div class="tally-tile t150b" id="tile150"><div class="tally-denom">‚Çπ150</div><div class="tally-count" id="tc150">0</div><div class="tally-val" id="tv150">‚Çπ0</div></div>
    <div class="tally-tile t200b" id="tile200"><div class="tally-denom">‚Çπ200</div><div class="tally-count" id="tc200">0</div><div class="tally-val" id="tv200">‚Çπ0</div></div>
  </div>

  <!-- Total -->
  <div class="total-bar">
    <div><div class="total-label">TOTAL</div><div class="total-tokens" id="totalTokens">0 tokens</div></div>
    <div class="total-amount" id="totalAmount">‚Çπ0</div>
  </div>

  <!-- Recent scan log -->
  <div class="scan-log" id="scanLog">
    <div class="empty-note" id="scanLogEmpty" style="padding:16px 0">Hold a token in the frame and tap "Scan Token"</div>
  </div>

  <!-- Actions -->
  <div class="scan-actions">
    <button class="big-btn scanning" id="scanTokenBtn" onclick="scanToken()">üîç Scan This Token</button>
    <div style="display:flex;gap:8px;">
      <button class="big-btn secondary" style="flex:1" onclick="undoLast()">‚Ü© Undo Last</button>
      <button class="big-btn gold" style="flex:1" id="doneBtn" onclick="finishSession()" disabled>‚úÖ Done</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê LOG ‚ïê‚ïê‚ïê -->
<div class="screen" id="logScreen">
  <div class="topbar">
    <button class="back-btn" onclick="showScreen('homeScreen')">‚Üê Back</button>
    <div style="text-align:right"><div class="topbar-title">Session <span>Log</span></div><div class="topbar-sub" id="logCount">0 entries</div></div>
  </div>
  <div class="scroll-content">
    <div class="grand-bar">
      <div><div class="gt-label">GRAND TOTAL PAYOUT</div><div class="gt-sub" id="gtTokens">0 tokens ¬∑ 0 dealers</div></div>
      <div class="gt-amt" id="gtAmount">‚Çπ0</div>
    </div>
    <div id="fullLogList"><div class="empty-note">No entries yet.</div></div>
    <div class="report-btns">
      <button class="btn-excel" onclick="exportExcel()">üìä Download Excel</button>
      <button class="btn-whatsapp" onclick="sendWhatsApp()">üí¨ WhatsApp</button>
    </div>
  </div>
  <div class="bottom-nav">
    <button class="nav-btn" onclick="showScreen('homeScreen')"><span class="nav-icon">üè†</span>Home</button>
    <button class="nav-btn" onclick="goToScan()"><span class="nav-icon">üì∑</span>Scan</button>
    <button class="nav-btn active"><span class="nav-icon">üìã</span>Log</button>
  </div>
</div>

<!-- INSTALL BANNER -->
<div class="install-banner hidden" id="installBanner">
  <div style="font-size:32px;flex-shrink:0">üì≤</div>
  <div style="flex:1"><div style="font-size:0.9rem;font-weight:800;margin-bottom:2px;">Add to Home Screen</div><div style="font-size:0.7rem;color:var(--muted);font-family:'Space Mono',monospace;">Use like a native app</div></div>
  <div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0;">
    <button class="btn-install" id="installBtn">Install</button>
    <button class="btn-dismiss" onclick="dismissInstall()">Not now</button>
  </div>
</div>

<script>
// ‚îÄ‚îÄ Constants ‚îÄ‚îÄ
const DENOMS = [25,50,75,100,150,200];
const DENOM_COLORS = {25:'#8B4513',50:'#4B0082',75:'#2d6a4f',100:'#cc2200',150:'#1a3a6b',200:'#cc0066'};
const DENOM_NAMES = {25:'Dark Brown',50:'Dark Purple',75:'Dark Green',100:'Bright Red',150:'Royal Blue',200:'Hot Pink'};

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let sessionLog = [];
let currentScan = {t25:0,t50:0,t75:0,t100:0,t150:0,t200:0};
let scanItems = []; // individual token scans for current session
let stream = null;
let isAnalyzing = false;
let pendingToken = null; // detected token waiting for confirm/reject

// ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='logScreen') renderFullLog();
  if(id==='homeScreen') renderHome();
}

function goToScan(){
  const d = document.getElementById('dealerName').value.trim();
  document.getElementById('scanDealerLabel').textContent = d || 'No dealer selected';
  resetScanSession();
  showScreen('scanScreen');
  startCamera();
}

function stopAndBack(){ stopCamera(); showScreen('homeScreen'); }

// ‚îÄ‚îÄ Camera ‚îÄ‚îÄ
async function startCamera(){
  setStatus('Starting camera‚Ä¶', false);
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:720}},
      audio:false
    });
    const v = document.getElementById('videoEl');
    v.srcObject = stream;
    await v.play();
    // Set camera wrap height to ~45% of screen
    document.getElementById('cameraWrap').style.height = Math.round(window.innerHeight * 0.38) + 'px';
    setStatus('Hold token inside the frame ‚Üí tap "Scan This Token"', false);
  }catch(e){
    setStatus('Camera blocked ‚Äî please allow camera access', false);
  }
}

function stopCamera(){
  if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
}

// ‚îÄ‚îÄ Scan token ‚îÄ‚îÄ
async function scanToken(){
  if(isAnalyzing || !stream) return;
  const v = document.getElementById('videoEl');
  const c = document.getElementById('snapCanvas');
  c.width = v.videoWidth||1280; c.height = v.videoHeight||720;
  c.getContext('2d').drawImage(v,0,0);
  const b64 = c.toDataURL('image/jpeg',0.85).split(',')[1];

  isAnalyzing = true;
  document.getElementById('scanTokenBtn').disabled = true;
  document.getElementById('scanTokenBtn').innerHTML = '<span class="spinner"></span> Identifying‚Ä¶';
  setStatus('Identifying token‚Ä¶', true);

  try{
    const resp = await fetch('/analyze',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({messages:[{role:'user',content:[
        {type:'image',source:{type:'base64',media_type:'image/jpeg',data:b64}},
        {type:'text',text:'What token is this?'}
      ]}]})
    });
    const data = await resp.json();
    const text = (data.content?.[0]?.text||'').replace(/```json|```/g,'').trim();
    const p = JSON.parse(text);

    if(p.value && p.value > 0){
      pendingToken = p.value;
      showPopup(p.value, p.color, p.confidence);
    } else {
      setStatus('No token detected ‚Äî try again', false);
      flashFrame('red');
    }
  }catch(err){
    setStatus('Error ‚Äî try again', false);
  }

  isAnalyzing = false;
  document.getElementById('scanTokenBtn').disabled = false;
  document.getElementById('scanTokenBtn').innerHTML = 'üîç Scan This Token';
}

// ‚îÄ‚îÄ Popup ‚îÄ‚îÄ
function showPopup(value, color, confidence){
  document.getElementById('popupDenom').textContent = '‚Çπ' + value;
  document.getElementById('popupColor').textContent = (color||DENOM_NAMES[value]) + (confidence==='low'?' (low confidence)':'');
  document.getElementById('detectPopup').classList.add('show');
  document.getElementById('detectFrame').classList.add('detected');
  flashFrame('green');
  // Vibrate
  if(navigator.vibrate) navigator.vibrate(100);
}

function hidePopup(){
  document.getElementById('detectPopup').classList.remove('show');
  document.getElementById('detectFrame').classList.remove('detected');
}

function confirmToken(){
  if(!pendingToken) return;
  addToken(pendingToken);
  hidePopup();
  pendingToken = null;
  setStatus('‚úì Added! Hold next token ‚Üí tap "Scan This Token"', false);
}

function rejectToken(){
  hidePopup();
  pendingToken = null;
  setStatus('Rejected. Try again with clearer view.', false);
}

function addToken(value){
  currentScan['t'+value]++;
  scanItems.unshift({value, time: new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',second:'2-digit'})});
  updateTally();
  renderScanLog();
  document.getElementById('doneBtn').disabled = false;
  if(navigator.vibrate) navigator.vibrate([50,30,50]);
}

function undoLast(){
  if(!scanItems.length) return;
  const last = scanItems.shift();
  currentScan['t'+last.value] = Math.max(0, currentScan['t'+last.value]-1);
  updateTally();
  renderScanLog();
  if(Object.values(currentScan).every(v=>v===0)) document.getElementById('doneBtn').disabled=true;
}

function flashFrame(color){
  const f = document.getElementById('detectFrame');
  const corners = f.querySelectorAll('.corner');
  corners.forEach(c=>{
    c.style.borderColor = color==='green' ? 'var(--green)' : 'var(--red)';
  });
  setTimeout(()=>{
    corners.forEach(c=>c.style.borderColor='');
  }, 500);
}

// ‚îÄ‚îÄ Tally ‚îÄ‚îÄ
function updateTally(){
  let total=0, totalT=0;
  DENOMS.forEach(d=>{
    const v = currentScan['t'+d];
    document.getElementById('tc'+d).textContent = v;
    document.getElementById('tv'+d).textContent = '‚Çπ'+(v*d);
    document.getElementById('tile'+d).classList.toggle('lit',v>0);
    total += v*d; totalT += v;
  });
  document.getElementById('totalAmount').textContent = '‚Çπ'+total.toLocaleString('en-IN');
  document.getElementById('totalTokens').textContent = totalT+' tokens';
  document.getElementById('statusCount').textContent = totalT+' scanned';
}

function renderScanLog(){
  const el = document.getElementById('scanLog');
  const empty = document.getElementById('scanLogEmpty');
  if(!scanItems.length){ empty.style.display='block'; return; }
  empty.style.display='none';
  // Keep existing items and prepend new one
  const existing = el.querySelectorAll('.scan-item');
  const newItem = document.createElement('div');
  newItem.className='scan-item';
  newItem.innerHTML=`
    <div class="scan-dot" style="background:${DENOM_COLORS[scanItems[0].value]}"></div>
    <div class="scan-info">
      <div class="scan-denom">‚Çπ${scanItems[0].value} token</div>
      <div class="scan-time">${scanItems[0].time} ¬∑ ${DENOM_NAMES[scanItems[0].value]}</div>
    </div>
    <div class="scan-amount">‚Çπ${scanItems[0].value}</div>
    <button class="scan-undo" onclick="undoLast()">undo</button>
  `;
  if(existing.length){ el.insertBefore(newItem, existing[0]); }
  else { el.appendChild(newItem); }
  // Refresh all items cleanly if too many
  if(el.querySelectorAll('.scan-item').length > scanItems.length){
    el.innerHTML='';
    scanItems.forEach(item=>{
      const div=document.createElement('div');
      div.className='scan-item';
      div.innerHTML=`
        <div class="scan-dot" style="background:${DENOM_COLORS[item.value]}"></div>
        <div class="scan-info">
          <div class="scan-denom">‚Çπ${item.value} token</div>
          <div class="scan-time">${item.time} ¬∑ ${DENOM_NAMES[item.value]}</div>
        </div>
        <div class="scan-amount">‚Çπ${item.value}</div>
      `;
      el.appendChild(div);
    });
  }
}

// ‚îÄ‚îÄ Finish session ‚îÄ‚îÄ
function finishSession(){
  const dealer = document.getElementById('dealerName').value.trim() || 'Unknown Dealer';
  const totalT = DENOMS.reduce((s,d)=>s+currentScan['t'+d],0);
  if(totalT===0) return;
  const total = DENOMS.reduce((s,d)=>s+currentScan['t'+d]*d,0);
  sessionLog.unshift({
    id:Date.now(), dealer,
    t25:currentScan.t25, t50:currentScan.t50, t75:currentScan.t75,
    t100:currentScan.t100, t150:currentScan.t150, t200:currentScan.t200,
    total, time:new Date().toLocaleString('en-IN'), approved:false,
    items:[...scanItems]
  });
  updateStats();
  document.getElementById('dealerName').value='';
  stopAndBack();
}

function resetScanSession(){
  stopCamera();
  currentScan={t25:0,t50:0,t75:0,t100:0,t150:0,t200:0};
  scanItems=[];
  pendingToken=null;
  isAnalyzing=false;
  updateTally();
  document.getElementById('scanLog').innerHTML='<div class="empty-note" id="scanLogEmpty" style="padding:16px 0">Hold a token in the frame and tap "Scan Token"</div>';
  document.getElementById('doneBtn').disabled=true;
  hidePopup();
}

function setStatus(msg, active){
  const el=document.getElementById('statusText');
  el.textContent=msg;
  el.className='status-text'+(active?' active':'');
}

// ‚îÄ‚îÄ Home & Log ‚îÄ‚îÄ
function entryDetailStr(e){
  let p=[];
  if(e.t25) p.push(`‚Çπ25√ó${e.t25}`);
  if(e.t50) p.push(`‚Çπ50√ó${e.t50}`);
  if(e.t75) p.push(`‚Çπ75√ó${e.t75}`);
  if(e.t100) p.push(`‚Çπ100√ó${e.t100}`);
  if(e.t150) p.push(`‚Çπ150√ó${e.t150}`);
  if(e.t200) p.push(`‚Çπ200√ó${e.t200}`);
  return p.join(' ¬∑ ');
}

function renderHome(){
  const el=document.getElementById('recentList');
  if(!sessionLog.length){el.innerHTML='<div class="empty-note">No entries yet.<br>Tap "Start Scanning Tokens" to begin.</div>';return;}
  el.innerHTML=sessionLog.slice(0,5).map(e=>`
    <div class="entry-card ${e.approved?'approved':''}">
      <div class="entry-top"><div class="entry-dealer">${e.dealer}</div><div class="entry-amount">‚Çπ${e.total.toLocaleString('en-IN')}</div></div>
      <div class="entry-detail">${entryDetailStr(e)}</div>
      <div class="entry-detail">${e.time}</div>
    </div>`).join('');
}

function renderFullLog(){
  const el=document.getElementById('fullLogList');
  document.getElementById('logCount').textContent=`${sessionLog.length} entries`;
  if(!sessionLog.length){el.innerHTML='<div class="empty-note">No entries yet.</div>';return;}
  const grand=sessionLog.reduce((s,e)=>s+e.total,0);
  const totalT=sessionLog.reduce((s,e)=>s+DENOMS.reduce((x,d)=>x+(e['t'+d]||0),0),0);
  document.getElementById('gtAmount').textContent='‚Çπ'+grand.toLocaleString('en-IN');
  document.getElementById('gtTokens').textContent=`${totalT} tokens ¬∑ ${sessionLog.length} dealers`;
  el.innerHTML=sessionLog.map(e=>`
    <div class="entry-card ${e.approved?'approved':''}">
      <div class="entry-top"><div class="entry-dealer">${e.dealer}</div><div class="entry-amount">‚Çπ${e.total.toLocaleString('en-IN')}</div></div>
      <div class="entry-detail">${entryDetailStr(e)}</div>
      <div class="entry-detail">${e.time}</div>
      ${e.approved?'<div style="color:var(--green);font-size:0.68rem;margin-top:4px;font-family:Space Mono,monospace">‚úì Approved</div>':''}
      <div class="entry-actions">
        ${!e.approved?`<button class="btn-approve" onclick="approve(${e.id})">‚úì Approve</button>`:''}
        <button class="btn-del" onclick="del(${e.id})">üóë</button>
      </div>
    </div>`).join('');
}

function approve(id){const e=sessionLog.find(x=>x.id===id);if(e){e.approved=true;renderFullLog();updateStats();}}
function del(id){sessionLog=sessionLog.filter(x=>x.id!==id);renderFullLog();updateStats();}
function updateStats(){
  document.getElementById('statEntries').textContent=sessionLog.length;
  document.getElementById('statTotal').textContent='‚Çπ'+sessionLog.reduce((s,e)=>s+e.total,0).toLocaleString('en-IN');
  renderHome();
}

// ‚îÄ‚îÄ Excel Export (using SheetJS via CDN) ‚îÄ‚îÄ
function exportExcel(){
  if(!sessionLog.length){alert('No entries to export.');return;}
  const XLSX = window.XLSX;
  const wb = XLSX.utils.book_new();

  // Sheet 1: Summary
  const summaryData = [
    ['MRF VAPOCURE PAINTS ‚Äî TOKEN REDEMPTION REPORT'],
    ['Generated:', new Date().toLocaleString('en-IN')],
    [],
    ['Dealer','‚Çπ25','‚Çπ50','‚Çπ75','‚Çπ100','‚Çπ150','‚Çπ200','Total Tokens','Total Amount (‚Çπ)','Date/Time','Status'],
    ...sessionLog.map(e=>[
      e.dealer, e.t25, e.t50, e.t75, e.t100, e.t150, e.t200,
      DENOMS.reduce((s,d)=>s+(e['t'+d]||0),0),
      e.total, e.time, e.approved?'Approved':'Pending'
    ]),
    [],
    ['GRAND TOTAL','','','','','','',
      sessionLog.reduce((s,e)=>s+DENOMS.reduce((x,d)=>x+(e['t'+d]||0),0),0),
      sessionLog.reduce((s,e)=>s+e.total,0),'','']
  ];
  const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
  ws1['!cols']=[{wch:25},{wch:6},{wch:6},{wch:6},{wch:7},{wch:7},{wch:7},{wch:14},{wch:18},{wch:22},{wch:10}];
  XLSX.utils.book_append_sheet(wb, ws1, 'Summary');

  // Sheet 2: Denomination breakdown
  const breakData = [
    ['DENOMINATION WISE SUMMARY'],
    [],
    ['Denomination','Total Tokens','Total Amount (‚Çπ)'],
    ...DENOMS.map(d=>[
      '‚Çπ'+d,
      sessionLog.reduce((s,e)=>s+(e['t'+d]||0),0),
      sessionLog.reduce((s,e)=>s+(e['t'+d]||0)*d,0)
    ]),
    [],
    ['TOTAL',
      sessionLog.reduce((s,e)=>s+DENOMS.reduce((x,d)=>x+(e['t'+d]||0),0),0),
      sessionLog.reduce((s,e)=>s+e.total,0)
    ]
  ];
  const ws2 = XLSX.utils.aoa_to_sheet(breakData);
  ws2['!cols']=[{wch:16},{wch:14},{wch:18}];
  XLSX.utils.book_append_sheet(wb, ws2, 'Denomination Summary');

  XLSX.writeFile(wb, `MRF_Tokens_${new Date().toISOString().slice(0,10)}.xlsx`);
}

// ‚îÄ‚îÄ WhatsApp Report ‚îÄ‚îÄ
function sendWhatsApp(){
  if(!sessionLog.length){alert('No entries to send.');return;}
  const grand = sessionLog.reduce((s,e)=>s+e.total,0);
  const totalT = sessionLog.reduce((s,e)=>s+DENOMS.reduce((x,d)=>x+(e['t'+d]||0),0),0);
  const date = new Date().toLocaleDateString('en-IN');

  let msg = `üé® *MRF Vapocure Paints*\n`;
  msg += `üìã *Token Redemption Report*\n`;
  msg += `üìÖ ${date}\n`;
  msg += `${'‚îÄ'.repeat(30)}\n\n`;

  sessionLog.forEach((e,i)=>{
    msg += `*${i+1}. ${e.dealer}*\n`;
    if(e.t25)  msg += `  ‚Çπ25  √ó ${e.t25}  = ‚Çπ${e.t25*25}\n`;
    if(e.t50)  msg += `  ‚Çπ50  √ó ${e.t50}  = ‚Çπ${e.t50*50}\n`;
    if(e.t75)  msg += `  ‚Çπ75  √ó ${e.t75}  = ‚Çπ${e.t75*75}\n`;
    if(e.t100) msg += `  ‚Çπ100 √ó ${e.t100} = ‚Çπ${e.t100*100}\n`;
    if(e.t150) msg += `  ‚Çπ150 √ó ${e.t150} = ‚Çπ${e.t150*150}\n`;
    if(e.t200) msg += `  ‚Çπ200 √ó ${e.t200} = ‚Çπ${e.t200*200}\n`;
    msg += `  *Total: ‚Çπ${e.total.toLocaleString('en-IN')}*\n\n`;
  });

  msg += `${'‚îÄ'.repeat(30)}\n`;
  msg += `üì¶ *Total Tokens: ${totalT}*\n`;
  msg += `üí∞ *Grand Total: ‚Çπ${grand.toLocaleString('en-IN')}*\n`;

  const encoded = encodeURIComponent(msg);
  window.open(`https://wa.me/?text=${encoded}`, '_blank');
}

// ‚îÄ‚îÄ PWA ‚îÄ‚îÄ
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault(); deferredPrompt=e;
  setTimeout(()=>{if(!localStorage.getItem('installDismissed')) document.getElementById('installBanner').classList.remove('hidden');},3000);
});
document.getElementById('installBtn').addEventListener('click',async()=>{
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt=null;
  document.getElementById('installBanner').classList.add('hidden');
});
function dismissInstall(){document.getElementById('installBanner').classList.add('hidden');localStorage.setItem('installDismissed','1');}
if('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js');
</script>

<!-- SheetJS for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>
