<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#ff4500">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>MRF Token Scanner</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap');
  :root {
    --bg:#0f0f0f; --surface:#1c1c1e; --border:#2c2c2e;
    --accent:#ff4500; --gold:#ffd60a; --text:#f5f5f7;
    --muted:#8e8e93; --green:#30d158; --red:#ff453a;
  }
  *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
  html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;overflow:hidden;}

  .screen{display:none;flex-direction:column;height:100vh;overflow:hidden;}
  .screen.active{display:flex;}

  /* TOPBAR */
  .topbar{
    flex-shrink:0;
    display:flex;align-items:center;justify-content:space-between;
    padding:50px 20px 14px;background:var(--surface);
    border-bottom:1px solid var(--border);
  }
  .topbar-title{font-size:1.1rem;font-weight:800;}
  .topbar-title span{color:var(--accent);}
  .topbar-sub{font-size:0.68rem;color:var(--muted);font-family:'Space Mono',monospace;}
  .back-btn{background:var(--border);border:none;color:var(--text);border-radius:8px;padding:8px 14px;font-family:'Syne',sans-serif;font-weight:700;font-size:0.85rem;cursor:pointer;}

  /* HOME */
  .scroll-content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:20px;}
  .section-label{font-size:0.65rem;font-family:'Space Mono',monospace;color:var(--muted);text-transform:uppercase;letter-spacing:2px;margin-bottom:8px;}
  .dealer-input{width:100%;background:var(--surface);border:1.5px solid var(--border);border-radius:12px;color:var(--text);font-family:'Syne',sans-serif;font-size:1rem;padding:14px 16px;outline:none;margin-bottom:14px;}
  .dealer-input:focus{border-color:var(--accent);}

  .scan-btn{width:100%;background:var(--accent);border:none;border-radius:16px;color:white;font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:800;padding:20px;cursor:pointer;margin-bottom:16px;box-shadow:0 4px 24px rgba(255,69,0,0.4);}
  .scan-btn:active{opacity:0.85;}

  .stats-strip{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;}
  .stat-box{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px;}
  .stat-label{font-size:0.62rem;color:var(--muted);font-family:'Space Mono',monospace;margin-bottom:4px;}
  .stat-value{font-size:1.5rem;font-weight:800;}
  .stat-value.money{color:var(--gold);}

  .entry-card{background:var(--surface);border:1px solid var(--border);border-left:3px solid var(--gold);border-radius:12px;padding:14px 16px;margin-bottom:10px;}
  .entry-card.approved{border-left-color:var(--green);}
  .entry-top{display:flex;justify-content:space-between;margin-bottom:3px;}
  .entry-dealer{font-weight:700;}
  .entry-amount{font-weight:800;color:var(--gold);font-family:'Space Mono',monospace;}
  .entry-detail{font-size:0.7rem;color:var(--muted);font-family:'Space Mono',monospace;}
  .entry-actions{display:flex;gap:8px;margin-top:10px;}
  .btn-approve{flex:1;background:var(--green);color:#000;border:none;border-radius:8px;padding:8px;font-family:'Syne',sans-serif;font-weight:700;font-size:0.8rem;cursor:pointer;}
  .btn-del{background:var(--border);color:var(--muted);border:none;border-radius:8px;padding:8px 14px;cursor:pointer;}
  .empty-note{text-align:center;color:var(--muted);font-size:0.82rem;padding:32px 0;font-family:'Space Mono',monospace;line-height:1.8;}

  /* BOTTOM NAV */
  .bottom-nav{flex-shrink:0;display:flex;background:var(--surface);border-top:1px solid var(--border);padding:10px 0 28px;}
  .nav-btn{flex:1;background:none;border:none;color:var(--muted);font-family:'Syne',sans-serif;font-size:0.7rem;font-weight:700;display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;padding:6px 0;}
  .nav-btn.active{color:var(--accent);}
  .nav-icon{font-size:20px;}

  /* SCAN SCREEN */
  #scanScreen{background:#000;}

  .camera-wrap{
    flex:1;position:relative;background:#000;
    display:flex;align-items:center;justify-content:center;
    overflow:hidden;
  }
  #videoEl{width:100%;height:100%;object-fit:cover;display:block;}
  #snapCanvas{display:none;}
  #previewImg{width:100%;height:100%;object-fit:contain;display:none;position:absolute;inset:0;background:#000;}

  .cam-overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;background:rgba(0,0,0,0.7);}
  .cam-overlay.hidden{display:none;}
  .cam-overlay p{color:var(--muted);font-size:0.82rem;text-align:center;padding:0 24px;line-height:1.6;}

  .corner{position:absolute;width:28px;height:28px;}
  .corner.tl{top:12px;left:12px;border-top:3px solid var(--accent);border-left:3px solid var(--accent);}
  .corner.tr{top:12px;right:12px;border-top:3px solid var(--accent);border-right:3px solid var(--accent);}
  .corner.bl{bottom:12px;left:12px;border-bottom:3px solid var(--accent);border-left:3px solid var(--accent);}
  .corner.br{bottom:12px;right:12px;border-bottom:3px solid var(--accent);border-right:3px solid var(--accent);}

  .mini-tally{flex-shrink:0;display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:10px 14px 0;}
  .mini-tile{background:#111;border-radius:10px;padding:8px;text-align:center;border:1px solid var(--border);}
  .mini-tile.lit{border-color:var(--accent);}
  .mini-denom{font-size:0.58rem;color:var(--muted);font-family:'Space Mono',monospace;}
  .mini-count{font-size:1.4rem;font-weight:800;}
  .mini-val{font-size:0.6rem;color:var(--gold);font-family:'Space Mono',monospace;}

  .result-panel{flex-shrink:0;background:#111;border-radius:12px;padding:10px 14px;margin:8px 14px 0;font-family:'Space Mono',monospace;font-size:0.73rem;line-height:1.6;color:var(--muted);border:1px solid var(--border);white-space:pre-wrap;max-height:90px;overflow-y:auto;}
  .result-panel.analyzing{border-color:var(--gold);color:var(--gold);}
  .result-panel.success{border-color:var(--green);color:var(--text);}
  .result-panel.error{border-color:var(--red);color:var(--red);}

  .scan-actions{flex-shrink:0;padding:10px 14px 32px;background:var(--surface);border-top:1px solid var(--border);display:flex;flex-direction:column;gap:8px;margin-top:8px;}
  .big-btn{width:100%;border:none;border-radius:14px;font-family:'Syne',sans-serif;font-weight:800;font-size:0.95rem;padding:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;}
  .big-btn:active{opacity:0.8;}
  .big-btn.primary{background:var(--accent);color:white;}
  .big-btn.secondary{background:var(--border);color:var(--text);}
  .big-btn.green{background:#1a5c1a;color:white;}
  .big-btn.gold{background:var(--gold);color:#000;}
  .big-btn:disabled{opacity:0.3;pointer-events:none;}

  /* LOG */
  .grand-bar{background:var(--accent);border-radius:12px;padding:16px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;}
  .gt-label{font-size:0.75rem;font-weight:700;opacity:0.85;}
  .gt-sub{font-size:0.62rem;opacity:0.65;font-family:'Space Mono',monospace;}
  .gt-amt{font-size:1.6rem;font-weight:800;font-family:'Space Mono',monospace;}
  .export-btn{width:100%;border:1.5px solid var(--gold);border-radius:12px;background:transparent;color:var(--gold);font-family:'Syne',sans-serif;font-weight:700;font-size:0.9rem;padding:14px;cursor:pointer;margin-top:16px;}
  .export-btn:active{background:var(--gold);color:#000;}

  /* INSTALL BANNER */
  .install-banner {
    position: fixed; bottom: 80px; left: 16px; right: 16px; z-index: 999;
    background: var(--surface); border: 1.5px solid var(--accent);
    border-radius: 16px; padding: 14px 16px;
    display: flex; align-items: center; gap: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    animation: slideUp 0.3s ease;
  }
  .install-banner.hidden { display: none; }
  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .install-icon { font-size: 32px; flex-shrink: 0; }
  .install-text { flex: 1; }
  .install-title { font-size: 0.9rem; font-weight: 800; margin-bottom: 2px; }
  .install-sub { font-size: 0.7rem; color: var(--muted); font-family: 'Space Mono', monospace; }
  .install-btns { display: flex; flex-direction: column; gap: 6px; flex-shrink: 0; }
  .btn-install { background: var(--accent); color: white; border: none; border-radius: 8px; padding: 8px 14px; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.8rem; cursor: pointer; white-space: nowrap; }
  .btn-dismiss { background: none; border: none; color: var(--muted); font-size: 0.75rem; cursor: pointer; text-align: center; }

  @keyframes spin{to{transform:rotate(360deg);}}
  .spinner{display:inline-block;width:13px;height:13px;border:2px solid transparent;border-top-color:currentColor;border-radius:50%;animation:spin 0.6s linear infinite;vertical-align:middle;margin-right:6px;}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê -->
<div class="screen active" id="homeScreen">
  <div class="topbar">
    <div>
      <div class="topbar-title">MRF <span>Tokens</span></div>
      <div class="topbar-sub">Vapocure Dealer Incentive</div>
    </div>
  </div>
  <div class="scroll-content">
    <div class="section-label">Dealer Name / Code</div>
    <input class="dealer-input" id="dealerName" type="text" placeholder="e.g. Ravi Paints ‚Äî DLR-042"/>
    <button class="scan-btn" onclick="goToScan()">üì∑ Scan Tokens</button>
    <div class="stats-strip">
      <div class="stat-box"><div class="stat-label">TODAY'S ENTRIES</div><div class="stat-value" id="statEntries">0</div></div>
      <div class="stat-box"><div class="stat-label">TOTAL PAYOUT</div><div class="stat-value money" id="statTotal">‚Çπ0</div></div>
    </div>
    <div class="section-label">Recent Entries</div>
    <div id="recentList"><div class="empty-note">No entries yet.<br>Tap "Scan Tokens" to begin.</div></div>
  </div>
  <div class="bottom-nav">
    <button class="nav-btn active" onclick="showScreen('homeScreen')"><span class="nav-icon">üè†</span>Home</button>
    <button class="nav-btn" onclick="goToScan()"><span class="nav-icon">üì∑</span>Scan</button>
    <button class="nav-btn" onclick="showScreen('logScreen')"><span class="nav-icon">üìã</span>Log</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê SCAN ‚ïê‚ïê‚ïê -->
<div class="screen" id="scanScreen">
  <div class="topbar">
    <button class="back-btn" onclick="stopAndBack()">‚Üê Back</button>
    <div style="text-align:right">
      <div class="topbar-title">Scan <span>Tokens</span></div>
      <div class="topbar-sub" id="scanDealerLabel">‚Äî</div>
    </div>
  </div>

  <div class="camera-wrap">
    <video id="videoEl" autoplay playsinline muted></video>
    <canvas id="snapCanvas"></canvas>
    <img id="previewImg" alt="snapshot"/>
    <div class="cam-overlay" id="camOverlay">
      <div style="font-size:52px">üì∑</div>
      <p id="overlayMsg">Starting camera‚Ä¶</p>
    </div>
    <div class="corner tl"></div><div class="corner tr"></div>
    <div class="corner bl"></div><div class="corner br"></div>
  </div>

  <div class="mini-tally">
    <div class="mini-tile" id="tile50"><div class="mini-denom">‚Çπ50</div><div class="mini-count" id="mc50">0</div><div class="mini-val" id="mv50">‚Çπ0</div></div>
    <div class="mini-tile" id="tile100"><div class="mini-denom">‚Çπ100</div><div class="mini-count" id="mc100">0</div><div class="mini-val" id="mv100">‚Çπ0</div></div>
    <div class="mini-tile" id="tile200"><div class="mini-denom">‚Çπ200</div><div class="mini-count" id="mc200">0</div><div class="mini-val" id="mv200">‚Çπ0</div></div>
  </div>

  <div class="result-panel" id="scanResult">Starting camera‚Ä¶</div>

  <div class="scan-actions">
    <button class="big-btn primary" id="snapBtn" onclick="takeSnapshot()" disabled>üì∏ Take Photo</button>
    <button class="big-btn green" id="analyzeBtn" onclick="analyzeTokens()" disabled>ü§ñ Count with AI</button>
    <div style="display:flex;gap:8px;">
      <!-- Upload fallback: label wraps hidden input ‚Äî works on HTTPS -->
      <label style="flex:1;cursor:pointer;">
        <input type="file" accept="image/*" onchange="handleUpload(event)" style="display:none;position:absolute;left:-9999px;width:1px;height:1px;">
        <div class="big-btn secondary" style="pointer-events:none;">üìÅ Upload</div>
      </label>
      <button class="big-btn gold" style="flex:1" id="logBtn" onclick="logEntry()" disabled>‚úÖ Log</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê LOG ‚ïê‚ïê‚ïê -->
<div class="screen" id="logScreen">
  <div class="topbar">
    <button class="back-btn" onclick="showScreen('homeScreen')">‚Üê Back</button>
    <div style="text-align:right">
      <div class="topbar-title">Session <span>Log</span></div>
      <div class="topbar-sub" id="logCount">0 entries</div>
    </div>
  </div>
  <div class="scroll-content">
    <div class="grand-bar">
      <div><div class="gt-label">GRAND TOTAL PAYOUT</div><div class="gt-sub" id="gtTokens">0 tokens ¬∑ 0 dealers</div></div>
      <div class="gt-amt" id="gtAmount">‚Çπ0</div>
    </div>
    <div id="fullLogList"><div class="empty-note">No entries yet.</div></div>
    <button class="export-btn" onclick="exportCSV()">‚¨á Export as CSV</button>
  </div>
  <div class="bottom-nav">
    <button class="nav-btn" onclick="showScreen('homeScreen')"><span class="nav-icon">üè†</span>Home</button>
    <button class="nav-btn" onclick="goToScan()"><span class="nav-icon">üì∑</span>Scan</button>
    <button class="nav-btn active"><span class="nav-icon">üìã</span>Log</button>
  </div>
</div>

<!-- INSTALL BANNER -->
<div class="install-banner hidden" id="installBanner">
  <div class="install-icon">üì≤</div>
  <div class="install-text">
    <div class="install-title">Add to Home Screen</div>
    <div class="install-sub">Use like a native app ‚Äî works offline too</div>
  </div>
  <div class="install-btns">
    <button class="btn-install" id="installBtn">Install</button>
    <button class="btn-dismiss" onclick="dismissInstall()">Not now</button>
  </div>
</div>

<script>
let sessionLog=[], currentB64=null, currentScan={t50:0,t100:0,t200:0}, stream=null;

// ‚îÄ‚îÄ CONFIG: paste your Cloudflare Worker URL here after setup ‚îÄ‚îÄ
const API_URL = '/analyze';

function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='logScreen') renderFullLog();
  if(id==='homeScreen') renderHome();
}

function goToScan(){
  const d=document.getElementById('dealerName').value.trim();
  document.getElementById('scanDealerLabel').textContent=d||'No dealer selected';
  resetScan();
  showScreen('scanScreen');
  startCamera();
}

function stopAndBack(){ stopCamera(); showScreen('homeScreen'); }

async function startCamera(){
  setResult('','Starting camera‚Ä¶');
  setOverlay(true,'Starting camera‚Ä¶');
  try{
    stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:'environment'},width:{ideal:1920},height:{ideal:1080}},
      audio:false
    });
    const v=document.getElementById('videoEl');
    v.srcObject=stream;
    await v.play();
    setOverlay(false);
    document.getElementById('snapBtn').disabled=false;
    setResult('','‚úì Camera ready ‚Äî point at tokens and tap "Take Photo"');
  }catch(e){
    setOverlay(true,'Camera blocked.\nUse "üìÅ Upload" below to pick a photo from your gallery.');
    setResult('error','Camera blocked.\n\nTap "üìÅ Upload" to select a photo of your tokens from your gallery.');
  }
}

function stopCamera(){
  if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
}

function takeSnapshot(){
  const v=document.getElementById('videoEl');
  const c=document.getElementById('snapCanvas');
  c.width=v.videoWidth||1280; c.height=v.videoHeight||720;
  c.getContext('2d').drawImage(v,0,0);
  currentB64=c.toDataURL('image/jpeg',0.85).split(',')[1];
  showPreview('data:image/jpeg;base64,'+currentB64);
  stopCamera();
  document.getElementById('snapBtn').textContent='üîÑ Retake';
  document.getElementById('snapBtn').onclick=retake;
  document.getElementById('analyzeBtn').disabled=false;
  setResult('','‚úì Photo taken ‚Äî tap "Count with AI"');
}

function showPreview(src){
  const img=document.getElementById('previewImg');
  img.src=src; img.style.display='block';
  document.getElementById('videoEl').style.display='none';
  setOverlay(false);
}

function retake(){
  currentB64=null; currentScan={t50:0,t100:0,t200:0};
  updateTally();
  document.getElementById('previewImg').style.display='none';
  document.getElementById('videoEl').style.display='block';
  document.getElementById('snapBtn').textContent='üì∏ Take Photo';
  document.getElementById('snapBtn').onclick=takeSnapshot;
  document.getElementById('analyzeBtn').disabled=true;
  document.getElementById('logBtn').disabled=true;
  setResult('','');
  startCamera();
}

function handleUpload(e){
  const f=e.target.files[0]; if(!f) return;
  stopCamera();
  const r=new FileReader();
  r.onload=ev=>{
    currentB64=ev.target.result.split(',')[1];
    showPreview(ev.target.result);
    document.getElementById('snapBtn').textContent='üîÑ Retake';
    document.getElementById('snapBtn').onclick=retake;
    document.getElementById('snapBtn').disabled=false;
    document.getElementById('analyzeBtn').disabled=false;
    setResult('','‚úì Photo loaded ‚Äî tap "Count with AI"');
  };
  r.readAsDataURL(f);
  e.target.value='';
}

function resetScan(){
  stopCamera();
  currentB64=null; currentScan={t50:0,t100:0,t200:0};
  updateTally();
  document.getElementById('previewImg').style.display='none';
  document.getElementById('videoEl').style.display='block';
  document.getElementById('videoEl').srcObject=null;
  document.getElementById('snapBtn').textContent='üì∏ Take Photo';
  document.getElementById('snapBtn').onclick=takeSnapshot;
  document.getElementById('snapBtn').disabled=true;
  document.getElementById('analyzeBtn').disabled=true;
  document.getElementById('logBtn').disabled=true;
  setOverlay(true,'Starting camera‚Ä¶');
}

async function analyzeTokens(){
  if(!currentB64) return;
  setResult('analyzing','<span class="spinner"></span> AI counting tokens‚Ä¶');
  document.getElementById('analyzeBtn').disabled=true;
  try{
    const resp=await fetch(API_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        messages:[{role:'user',content:[
          {type:'image',source:{type:'base64',media_type:'image/jpeg',data:currentB64}},
          {type:'text',text:`Count MRF Vapocure paint incentive tokens in this image:
- ‚Çπ50: WHITE background, dark border, "‚Çπ50" text
- ‚Çπ100: RED background, "Rs.100" + MRF Vapocure logo
- ‚Çπ200: PINK/MAGENTA background, "Rs.200" + MRF Vapocure logo
Reply ONLY in JSON, no markdown: {"t50":<n>,"t100":<n>,"t200":<n>,"notes":"<observation>"}`}
        ]}]
      })
    });
    const data=await resp.json();
    const text=(data.content?.[0]?.text||'').replace(/```json|```/g,'').trim();
    const p=JSON.parse(text);
    currentScan={t50:p.t50||0,t100:p.t100||0,t200:p.t200||0};
    updateTally();
    const total=currentScan.t50*50+currentScan.t100*100+currentScan.t200*200;
    const totalT=currentScan.t50+currentScan.t100+currentScan.t200;
    setResult('success',
      `‚úÖ DONE\n‚Çπ50 √ó ${currentScan.t50} = ‚Çπ${currentScan.t50*50}\n`+
      `‚Çπ100 √ó ${currentScan.t100} = ‚Çπ${currentScan.t100*100}\n`+
      `‚Çπ200 √ó ${currentScan.t200} = ‚Çπ${currentScan.t200*200}\n`+
      `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n${totalT} tokens ‚Üí ‚Çπ${total.toLocaleString('en-IN')}`+
      (p.notes?`\nüìå ${p.notes}`:'')
    );
    document.getElementById('logBtn').disabled=totalT===0;
  }catch(err){
    setResult('error',`‚ö† Failed: ${err.message}`);
  }
  document.getElementById('analyzeBtn').disabled=false;
}

function updateTally(){
  const{t50,t100,t200}=currentScan;
  document.getElementById('mc50').textContent=t50;
  document.getElementById('mc100').textContent=t100;
  document.getElementById('mc200').textContent=t200;
  document.getElementById('mv50').textContent='‚Çπ'+(t50*50);
  document.getElementById('mv100').textContent='‚Çπ'+(t100*100);
  document.getElementById('mv200').textContent='‚Çπ'+(t200*200);
  ['50','100','200'].forEach(d=>document.getElementById('tile'+d).classList.toggle('lit',currentScan['t'+d]>0));
}

function logEntry(){
  const dealer=document.getElementById('dealerName').value.trim()||'Unknown Dealer';
  const{t50,t100,t200}=currentScan;
  if(t50+t100+t200===0) return;
  sessionLog.unshift({id:Date.now(),dealer,t50,t100,t200,total:t50*50+t100*100+t200*200,time:new Date().toLocaleString('en-IN'),approved:false});
  updateStats();
  document.getElementById('dealerName').value='';
  stopAndBack();
}

function renderHome(){
  const el=document.getElementById('recentList');
  if(!sessionLog.length){el.innerHTML='<div class="empty-note">No entries yet.<br>Tap "Scan Tokens" to begin.</div>';return;}
  el.innerHTML=sessionLog.slice(0,5).map(e=>`
    <div class="entry-card ${e.approved?'approved':''}">
      <div class="entry-top"><div class="entry-dealer">${e.dealer}</div><div class="entry-amount">‚Çπ${e.total.toLocaleString('en-IN')}</div></div>
      <div class="entry-detail">‚Çπ50√ó${e.t50} ¬∑ ‚Çπ100√ó${e.t100} ¬∑ ‚Çπ200√ó${e.t200} ¬∑ ${e.time}</div>
    </div>`).join('');
}

function renderFullLog(){
  const el=document.getElementById('fullLogList');
  document.getElementById('logCount').textContent=`${sessionLog.length} entries`;
  if(!sessionLog.length){el.innerHTML='<div class="empty-note">No entries yet.</div>';return;}
  const grand=sessionLog.reduce((s,e)=>s+e.total,0);
  const totalT=sessionLog.reduce((s,e)=>s+e.t50+e.t100+e.t200,0);
  document.getElementById('gtAmount').textContent='‚Çπ'+grand.toLocaleString('en-IN');
  document.getElementById('gtTokens').textContent=`${totalT} tokens ¬∑ ${sessionLog.length} dealers`;
  el.innerHTML=sessionLog.map(e=>`
    <div class="entry-card ${e.approved?'approved':''}" id="entry-${e.id}">
      <div class="entry-top"><div class="entry-dealer">${e.dealer}</div><div class="entry-amount">‚Çπ${e.total.toLocaleString('en-IN')}</div></div>
      <div class="entry-detail">‚Çπ50√ó${e.t50} ¬∑ ‚Çπ100√ó${e.t100} ¬∑ ‚Çπ200√ó${e.t200}</div>
      <div class="entry-detail">${e.time}</div>
      ${e.approved?'<div style="color:var(--green);font-size:0.68rem;margin-top:4px;font-family:Space Mono,monospace">‚úì Approved</div>':''}
      <div class="entry-actions">
        ${!e.approved?`<button class="btn-approve" onclick="approve(${e.id})">‚úì Approve</button>`:''}
        <button class="btn-del" onclick="del(${e.id})">üóë</button>
      </div>
    </div>`).join('');
}

function approve(id){const e=sessionLog.find(x=>x.id===id);if(e){e.approved=true;renderFullLog();updateStats();}}
function del(id){sessionLog=sessionLog.filter(x=>x.id!==id);renderFullLog();updateStats();}
function updateStats(){
  document.getElementById('statEntries').textContent=sessionLog.length;
  document.getElementById('statTotal').textContent='‚Çπ'+sessionLog.reduce((s,e)=>s+e.total,0).toLocaleString('en-IN');
  renderHome();
}

function exportCSV(){
  if(!sessionLog.length){alert('No entries to export.');return;}
  const rows=[['Dealer','‚Çπ50','‚Çπ100','‚Çπ200','Total (‚Çπ)','Time','Status'],
    ...sessionLog.map(e=>[e.dealer,e.t50,e.t100,e.t200,e.total,e.time,e.approved?'Approved':'Pending'])];
  rows.push(['GRAND TOTAL','','','',sessionLog.reduce((s,e)=>s+e.total,0),'','']);
  const csv=rows.map(r=>r.map(c=>`"${c}"`).join(',')).join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download=`mrf_tokens_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);a.click();document.body.removeChild(a);
}

function setResult(type,html){
  const el=document.getElementById('scanResult');
  el.className='result-panel'+(type?' '+type:'');
  el.innerHTML=html;
}
function setOverlay(show,msg=''){
  const el=document.getElementById('camOverlay');
  el.classList.toggle('hidden',!show);
  if(msg) document.getElementById('overlayMsg').textContent=msg;
}

// ‚îÄ‚îÄ PWA Install ‚îÄ‚îÄ
let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  // Show banner after 3 seconds
  setTimeout(() => {
    if (!localStorage.getItem('installDismissed')) {
      document.getElementById('installBanner').classList.remove('hidden');
    }
  }, 3000);
});

document.getElementById('installBtn').addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  deferredPrompt = null;
  document.getElementById('installBanner').classList.add('hidden');
});

function dismissInstall() {
  document.getElementById('installBanner').classList.add('hidden');
  localStorage.setItem('installDismissed', '1');
}

window.addEventListener('appinstalled', () => {
  document.getElementById('installBanner').classList.add('hidden');
});

// ‚îÄ‚îÄ Service Worker ‚îÄ‚îÄ
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js');
}
</script>
</body>
</html>
